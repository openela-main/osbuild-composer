From 3f3bee2270f5a032335bb47d5e6a12f64ccc0895 Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Tue, 14 Mar 2023 23:30:51 +0100
Subject: [PATCH 05/22] osbuild: name in containers input is not optional

Remove the `omitempty` from the name field in the containers input.  It is
required.
---
 internal/osbuild/containers_input.go | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/internal/osbuild/containers_input.go b/internal/osbuild/containers_input.go
index a27963882..c1803fa90 100644
--- a/internal/osbuild/containers_input.go
+++ b/internal/osbuild/containers_input.go
@@ -9,7 +9,7 @@ type ContainersInputReferences interface {
 }
 
 type ContainersInputSourceRef struct {
-	Name string `json:"name,omitempty"`
+	Name string `json:"name"`
 }
 
 type ContainersInputSourceMap map[string]ContainersInputSourceRef
-- 
2.40.0


From f546d3c32b8db6167cc27d0408d41fc7cbc152a4 Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Fri, 17 Mar 2023 13:23:48 +0100
Subject: [PATCH 06/22] osbuild: add skopeo-index source

New osbuild source that can download a manifest-list from a container
registry, using the `--multi-arch=index-only` option of skopeo copy.
---
 internal/osbuild/skopeo_index_source.go | 57 +++++++++++++++++++++++++
 1 file changed, 57 insertions(+)
 create mode 100644 internal/osbuild/skopeo_index_source.go

diff --git a/internal/osbuild/skopeo_index_source.go b/internal/osbuild/skopeo_index_source.go
new file mode 100644
index 000000000..d273fb138
--- /dev/null
+++ b/internal/osbuild/skopeo_index_source.go
@@ -0,0 +1,57 @@
+package osbuild
+
+import (
+	"fmt"
+)
+
+type SkopeoIndexSource struct {
+	Items map[string]SkopeoIndexSourceItem `json:"items"`
+}
+
+func (SkopeoIndexSource) isSource() {}
+
+type SkopeoIndexSourceImage struct {
+	Name      string `json:"name"`
+	TLSVerify *bool  `json:"tls-verify,omitempty"`
+}
+
+type SkopeoIndexSourceItem struct {
+	Image SkopeoIndexSourceImage `json:"image"`
+}
+
+func (item SkopeoIndexSourceItem) validate() error {
+
+	if item.Image.Name == "" {
+		return fmt.Errorf("source item has empty name")
+	}
+
+	return nil
+}
+
+// NewSkopeoIndexSource creates a new and empty SkopeoIndexSource
+func NewSkopeoIndexSource() *SkopeoIndexSource {
+	return &SkopeoIndexSource{
+		Items: make(map[string]SkopeoIndexSourceItem),
+	}
+}
+
+// AddItem adds a source item to the source; will panic
+// if any of the supplied options are invalid or missing
+func (source *SkopeoIndexSource) AddItem(name, image string, tlsVerify *bool) {
+	item := SkopeoIndexSourceItem{
+		Image: SkopeoIndexSourceImage{
+			Name:      name,
+			TLSVerify: tlsVerify,
+		},
+	}
+
+	if err := item.validate(); err != nil {
+		panic(err)
+	}
+
+	if !skopeoDigestPattern.MatchString(image) {
+		panic("item has invalid image id")
+	}
+
+	source.Items[image] = item
+}
-- 
2.40.0


From aed5ac61b95c49bd87cde724da82ceb636a1ab07 Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Fri, 17 Mar 2023 15:48:19 +0100
Subject: [PATCH 07/22] osbuild/skopeo: reverse the constructor args

Put the path (which becomes an option) first and the inputs second.
This is more in line with other stage constructors.
---
 internal/manifest/os.go          | 2 +-
 internal/osbuild/skopeo_stage.go | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/internal/manifest/os.go b/internal/manifest/os.go
index 6f0f50209..c5d632850 100644
--- a/internal/manifest/os.go
+++ b/internal/manifest/os.go
@@ -348,7 +348,7 @@ func (p *OS) serialize() osbuild.Pipeline {
 			pipeline.AddStage(osbuild.NewContainersStorageConfStage(containerStoreOpts))
 		}
 
-		skopeo := osbuild.NewSkopeoStage(images, storagePath)
+		skopeo := osbuild.NewSkopeoStage(storagePath, images)
 		pipeline.AddStage(skopeo)
 	}
 
diff --git a/internal/osbuild/skopeo_stage.go b/internal/osbuild/skopeo_stage.go
index 83260e501..c0ac14fbd 100644
--- a/internal/osbuild/skopeo_stage.go
+++ b/internal/osbuild/skopeo_stage.go
@@ -12,7 +12,7 @@ type SkopeoStageOptions struct {
 
 func (o SkopeoStageOptions) isStageOptions() {}
 
-func NewSkopeoStage(images ContainersInput, path string) *Stage {
+func NewSkopeoStage(path string, images ContainersInput) *Stage {
 
 	inputs := ContainersInputs{
 		"images": images,
-- 
2.40.0


From 724192bdce2f65e02b4446f09882b93eac4f5b76 Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Fri, 17 Mar 2023 13:25:07 +0100
Subject: [PATCH 08/22] osbuild: add manifest-lists input to skopeo stage

The skopeo stage in osbuild supports an second optional set of inputs
called `manifest-lists`.  This is an array of files, i.e.,
`org.osbuild.files` type input.

To support this we need a new type for the skopeo stage inputs that can
encompass both input types, images and manifest-lists.
---
 internal/manifest/os.go          |  2 +-
 internal/osbuild/skopeo_stage.go | 14 +++++++++++---
 2 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/internal/manifest/os.go b/internal/manifest/os.go
index c5d632850..783d9adce 100644
--- a/internal/manifest/os.go
+++ b/internal/manifest/os.go
@@ -348,7 +348,7 @@ func (p *OS) serialize() osbuild.Pipeline {
 			pipeline.AddStage(osbuild.NewContainersStorageConfStage(containerStoreOpts))
 		}
 
-		skopeo := osbuild.NewSkopeoStage(storagePath, images)
+		skopeo := osbuild.NewSkopeoStage(storagePath, images, nil)
 		pipeline.AddStage(skopeo)
 	}
 
diff --git a/internal/osbuild/skopeo_stage.go b/internal/osbuild/skopeo_stage.go
index c0ac14fbd..7efa70ba9 100644
--- a/internal/osbuild/skopeo_stage.go
+++ b/internal/osbuild/skopeo_stage.go
@@ -12,10 +12,18 @@ type SkopeoStageOptions struct {
 
 func (o SkopeoStageOptions) isStageOptions() {}
 
-func NewSkopeoStage(path string, images ContainersInput) *Stage {
+type SkopeoStageInputs struct {
+	Images        ContainersInput `json:"images"`
+	ManifestLists *FilesInput     `json:"manifest-lists,omitempty"`
+}
+
+func (SkopeoStageInputs) isStageInputs() {}
+
+func NewSkopeoStage(path string, images ContainersInput, manifests *FilesInput) *Stage {
 
-	inputs := ContainersInputs{
-		"images": images,
+	inputs := SkopeoStageInputs{
+		Images:        images,
+		ManifestLists: manifests,
 	}
 
 	return &Stage{
-- 
2.40.0


From 6c6ab39829cb2343a46e5ef01b6f956fbd3422ac Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Fri, 17 Mar 2023 15:19:41 +0100
Subject: [PATCH 09/22] container: add ListDigest to the spec

Add the ListDigest to the container Spec struct and all its copies so we
can store list digests when they are available and pass them on to the
appropriate osbuild stages, sources, and inputs.

Copy the value whenever a spec is moved to a different representation.
---
 cmd/osbuild-worker/jobimpl-container-resolve.go | 11 ++++++-----
 internal/cloudapi/v2/server.go                  |  1 +
 internal/container/spec.go                      | 11 ++++++-----
 internal/weldr/api.go                           |  1 +
 internal/worker/json.go                         |  5 +++--
 5 files changed, 17 insertions(+), 12 deletions(-)

diff --git a/cmd/osbuild-worker/jobimpl-container-resolve.go b/cmd/osbuild-worker/jobimpl-container-resolve.go
index ebeaff9d9..b92f5c893 100644
--- a/cmd/osbuild-worker/jobimpl-container-resolve.go
+++ b/cmd/osbuild-worker/jobimpl-container-resolve.go
@@ -42,11 +42,12 @@ func (impl *ContainerResolveJobImpl) Run(job worker.Job) error {
 	} else {
 		for i, spec := range specs {
 			result.Specs[i] = worker.ContainerSpec{
-				Source:    spec.Source,
-				Name:      spec.LocalName,
-				TLSVerify: spec.TLSVerify,
-				ImageID:   spec.ImageID,
-				Digest:    spec.Digest,
+				Source:     spec.Source,
+				Name:       spec.LocalName,
+				TLSVerify:  spec.TLSVerify,
+				ImageID:    spec.ImageID,
+				Digest:     spec.Digest,
+				ListDigest: spec.ListDigest,
 			}
 		}
 	}
diff --git a/internal/cloudapi/v2/server.go b/internal/cloudapi/v2/server.go
index fdae5eeae..807b32ba2 100644
--- a/internal/cloudapi/v2/server.go
+++ b/internal/cloudapi/v2/server.go
@@ -434,6 +434,7 @@ func generateManifest(ctx context.Context, workers *worker.Server, depsolveJobID
 			containerSpecs[i].LocalName = s.Name
 			containerSpecs[i].TLSVerify = s.TLSVerify
 			containerSpecs[i].ImageID = s.ImageID
+			containerSpecs[i].ListDigest = s.ListDigest
 		}
 	}
 
diff --git a/internal/container/spec.go b/internal/container/spec.go
index ffd781c8d..b7bfbe37e 100644
--- a/internal/container/spec.go
+++ b/internal/container/spec.go
@@ -11,11 +11,12 @@ import (
 // at the Source via Digest and ImageID. The latter one
 // should remain the same in the target image as well.
 type Spec struct {
-	Source    string // does not include the manifest digest
-	Digest    string // digest of the manifest at the Source
-	TLSVerify *bool  // controls TLS verification
-	ImageID   string // container image identifier
-	LocalName string // name to use inside the image
+	Source     string // does not include the manifest digest
+	Digest     string // digest of the manifest at the Source
+	TLSVerify  *bool  // controls TLS verification
+	ImageID    string // container image identifier
+	LocalName  string // name to use inside the image
+	ListDigest string // digest of the list manifest at the Source (optional)
 }
 
 // NewSpec creates a new Spec from the essential information.
diff --git a/internal/weldr/api.go b/internal/weldr/api.go
index db335c370..a2febe2dc 100644
--- a/internal/weldr/api.go
+++ b/internal/weldr/api.go
@@ -2303,6 +2303,7 @@ func (api *API) resolveContainersForImageType(bp blueprint.Blueprint, imageType
 		specs[i].LocalName = s.Name
 		specs[i].TLSVerify = s.TLSVerify
 		specs[i].ImageID = s.ImageID
+		specs[i].ListDigest = s.ListDigest
 	}
 
 	return specs, nil
diff --git a/internal/worker/json.go b/internal/worker/json.go
index 47d58bd12..b514b5914 100644
--- a/internal/worker/json.go
+++ b/internal/worker/json.go
@@ -241,8 +241,9 @@ type ContainerSpec struct {
 	Name      string `json:"name"`
 	TLSVerify *bool  `json:"tls-verify,omitempty"`
 
-	ImageID string `json:"image_id"`
-	Digest  string `json:"digest"`
+	ImageID    string `json:"image_id"`
+	Digest     string `json:"digest"`
+	ListDigest string `json:"list-digest,omitempty"`
 }
 
 type ContainerResolveJob struct {
-- 
2.40.0


From b72f23d68bd513d32af8ae4226de73df47ecc9f2 Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Thu, 13 Apr 2023 16:40:15 +0200
Subject: [PATCH 10/22] container: include TLSVerify and ListDigest in spec
 ctor

---
 internal/container/client.go |  3 +--
 internal/container/spec.go   | 13 +++++++------
 2 files changed, 8 insertions(+), 8 deletions(-)

diff --git a/internal/container/client.go b/internal/container/client.go
index 25ddbe7d6..df170eae9 100644
--- a/internal/container/client.go
+++ b/internal/container/client.go
@@ -480,8 +480,7 @@ func (cl *Client) Resolve(ctx context.Context, name string) (Spec, error) {
 		return Spec{}, err
 	}
 
-	spec := NewSpec(cl.Target, ids.Manifest, ids.Config)
-	spec.TLSVerify = cl.GetTLSVerify()
+	spec := NewSpec(cl.Target, ids.Manifest, ids.Config, cl.GetTLSVerify(), "")
 
 	return spec, nil
 }
diff --git a/internal/container/spec.go b/internal/container/spec.go
index b7bfbe37e..a9db3f731 100644
--- a/internal/container/spec.go
+++ b/internal/container/spec.go
@@ -22,13 +22,14 @@ type Spec struct {
 // NewSpec creates a new Spec from the essential information.
 // It also converts is the transition point from container
 // specific types (digest.Digest) to generic types (string).
-func NewSpec(source reference.Named, digest, imageID digest.Digest) Spec {
+func NewSpec(source reference.Named, digest, imageID digest.Digest, tlsVerify *bool, listDigest string) Spec {
 	name := source.Name()
 	return Spec{
-		Source:  name,
-		Digest:  digest.String(),
-		ImageID: imageID.String(),
-
-		LocalName: name,
+		Source:     name,
+		Digest:     digest.String(),
+		TLSVerify:  tlsVerify,
+		ImageID:    imageID.String(),
+		LocalName:  name,
+		ListDigest: listDigest,
 	}
 }
-- 
2.40.0


From 1b97a4d64435d3f7415a819784dc0f2856b39ffb Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Fri, 17 Mar 2023 15:22:13 +0100
Subject: [PATCH 11/22] container: save manifest list digest when resolving

While resolving a manifest list digest, store the list digest to return
with the resolvedIds.

This is done for both types of manifest list:
  application/vnd.docker.distribution.manifest.list.v2+json
and
  application/vnd.oci.image.index.v1+json
---
 internal/container/client.go | 32 ++++++++++++++++++++++++++------
 1 file changed, 26 insertions(+), 6 deletions(-)

diff --git a/internal/container/client.go b/internal/container/client.go
index df170eae9..5e03d31c1 100644
--- a/internal/container/client.go
+++ b/internal/container/client.go
@@ -391,8 +391,9 @@ type manifestList interface {
 }
 
 type resolvedIds struct {
-	Manifest digest.Digest
-	Config   digest.Digest
+	Manifest     digest.Digest
+	Config       digest.Digest
+	ListManifest digest.Digest
 }
 
 func (cl *Client) resolveManifestList(ctx context.Context, list manifestList) (resolvedIds, error) {
@@ -407,7 +408,12 @@ func (cl *Client) resolveManifestList(ctx context.Context, list manifestList) (r
 		return resolvedIds{}, fmt.Errorf("error getting manifest: %w", err)
 	}
 
-	return cl.resolveRawManifest(ctx, raw)
+	ids, err := cl.resolveRawManifest(ctx, raw)
+	if err != nil {
+		return resolvedIds{}, err
+	}
+
+	return ids, err
 }
 
 func (cl *Client) resolveRawManifest(ctx context.Context, rm RawManifest) (resolvedIds, error) {
@@ -421,7 +427,14 @@ func (cl *Client) resolveRawManifest(ctx context.Context, rm RawManifest) (resol
 			return resolvedIds{}, err
 		}
 
-		return cl.resolveManifestList(ctx, list)
+		// Save digest of the manifest list as well.
+		ids, err := cl.resolveManifestList(ctx, list)
+		if err != nil {
+			return resolvedIds{}, err
+		}
+		// NOTE: Comment in Digest() source says this should never fail. Ignore the error.
+		ids.ListManifest, _ = rm.Digest()
+		return ids, nil
 
 	case imgspecv1.MediaTypeImageIndex:
 		index, err := manifest.OCI1IndexFromManifest(rm.Data)
@@ -429,7 +442,14 @@ func (cl *Client) resolveRawManifest(ctx context.Context, rm RawManifest) (resol
 			return resolvedIds{}, err
 		}
 
-		return cl.resolveManifestList(ctx, index)
+		// Save digest of the manifest list as well.
+		ids, err := cl.resolveManifestList(ctx, index)
+		if err != nil {
+			return resolvedIds{}, err
+		}
+		// NOTE: Comment in Digest() source says this should never fail. Ignore the error.
+		ids.ListManifest, _ = rm.Digest()
+		return ids, nil
 
 	case imgspecv1.MediaTypeImageManifest:
 		m, err := manifest.OCI1FromManifest(rm.Data)
@@ -480,7 +500,7 @@ func (cl *Client) Resolve(ctx context.Context, name string) (Spec, error) {
 		return Spec{}, err
 	}
 
-	spec := NewSpec(cl.Target, ids.Manifest, ids.Config, cl.GetTLSVerify(), "")
+	spec := NewSpec(cl.Target, ids.Manifest, ids.Config, cl.GetTLSVerify(), ids.ListManifest.String())
 
 	return spec, nil
 }
-- 
2.40.0


From 27c7438b44870e6e79c24e45fa428ee158e5706a Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Fri, 17 Mar 2023 15:25:48 +0100
Subject: [PATCH 12/22] osbuild: create skopeo-index source in GenSources()

When generating sources in GenSources(), add a skopeo-index source
reference for each list-digest found in the container specs.
---
 internal/osbuild/source.go | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/internal/osbuild/source.go b/internal/osbuild/source.go
index 6d3a51948..862a5c3f1 100644
--- a/internal/osbuild/source.go
+++ b/internal/osbuild/source.go
@@ -102,13 +102,22 @@ func GenSources(packages []rpmmd.PackageSpec, ostreeCommits []ostree.CommitSpec,
 	}
 
 	skopeo := NewSkopeoSource()
+	skopeoIndex := NewSkopeoIndexSource()
 	for _, c := range containers {
 		skopeo.AddItem(c.Source, c.Digest, c.ImageID, c.TLSVerify)
+
+		// if we have a list digest, add a skopeo-index source as well
+		if c.ListDigest != "" {
+			skopeoIndex.AddItem(c.Source, c.ListDigest, c.TLSVerify)
+		}
 	}
 
 	if len(skopeo.Items) > 0 {
 		sources["org.osbuild.skopeo"] = skopeo
 	}
+	if len(skopeoIndex.Items) > 0 {
+		sources["org.osbuild.skopeo-index"] = skopeoIndex
+	}
 
 	return sources
 }
-- 
2.40.0


From a629331debd1ff8f3ef3f525232709b60e13581e Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Fri, 17 Mar 2023 16:07:40 +0100
Subject: [PATCH 13/22] osbuild/skopeo: helper function for files input

Add a helper function that collects all the manifest list digests from a
list of container specs and returns a FilesInput to be used with the
stage.

Use the function in the OS pipeline when adding containers.  The
manifests input to the stage constructor will be empty if there are no
manifest lists in the container specs.
---
 internal/manifest/os.go                        |  3 ++-
 internal/osbuild/files_input.go                | 18 ++++++++++++++++++
 ...arch64-edge_commit_with_container-boot.json |  3 ++-
 ...x86_64-edge_commit_with_container-boot.json |  3 ++-
 4 files changed, 24 insertions(+), 3 deletions(-)

diff --git a/internal/manifest/os.go b/internal/manifest/os.go
index 783d9adce..57a79d781 100644
--- a/internal/manifest/os.go
+++ b/internal/manifest/os.go
@@ -348,7 +348,8 @@ func (p *OS) serialize() osbuild.Pipeline {
 			pipeline.AddStage(osbuild.NewContainersStorageConfStage(containerStoreOpts))
 		}
 
-		skopeo := osbuild.NewSkopeoStage(storagePath, images, nil)
+		manifests := osbuild.NewFilesInputForManifestLists(p.Containers)
+		skopeo := osbuild.NewSkopeoStage(storagePath, images, manifests)
 		pipeline.AddStage(skopeo)
 	}
 
diff --git a/internal/osbuild/files_input.go b/internal/osbuild/files_input.go
index 64f685bf4..757d3b1cc 100644
--- a/internal/osbuild/files_input.go
+++ b/internal/osbuild/files_input.go
@@ -3,6 +3,8 @@ package osbuild
 import (
 	"encoding/json"
 	"fmt"
+
+	"github.com/osbuild/osbuild-composer/internal/container"
 )
 
 // SPECIFIC INPUT STRUCTURE
@@ -276,3 +278,19 @@ func NewFilesInputSourceObjectRef(entries map[string]FilesInputRefMetadata) File
 	}
 	return &refs
 }
+
+// NewFilesInputForManifestLists creates a FilesInput for container manifest
+// lists. If there are no list digests in the container specs, it returns nil.
+func NewFilesInputForManifestLists(containers []container.Spec) *FilesInput {
+	refs := make([]string, 0, len(containers))
+	for _, c := range containers {
+		if c.ListDigest != "" {
+			refs = append(refs, c.ListDigest)
+		}
+	}
+	if len(refs) == 0 {
+		return nil
+	}
+	filesRef := FilesInputSourcePlainRef(refs)
+	return NewFilesInput(&filesRef)
+}
diff --git a/test/data/manifests/centos_9-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/centos_9-aarch64-edge_commit_with_container-boot.json
index 75ed7d5de..db87c4eff 100644
--- a/test/data/manifests/centos_9-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/centos_9-aarch64-edge_commit_with_container-boot.json
@@ -11327,7 +11327,8 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/centos_9-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/centos_9-x86_64-edge_commit_with_container-boot.json
index ca818de26..acb5b01d7 100644
--- a/test/data/manifests/centos_9-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/centos_9-x86_64-edge_commit_with_container-boot.json
@@ -11827,7 +11827,8 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
     }
   ],
   "no-image-info": true
-- 
2.40.0


From 7c613fa7d56d19b62cbebe64aa0296daa91b5da9 Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Fri, 17 Mar 2023 17:41:30 +0100
Subject: [PATCH 14/22] containers: update tests

Update tests to include the list digests of the test images.
---
 internal/container/client_test.go    | 24 +++++++++++++-----------
 internal/container/container_test.go | 12 +++++++-----
 2 files changed, 20 insertions(+), 16 deletions(-)

diff --git a/internal/container/client_test.go b/internal/container/client_test.go
index 7133fad04..49695dae9 100644
--- a/internal/container/client_test.go
+++ b/internal/container/client_test.go
@@ -19,7 +19,7 @@ func TestClientResolve(t *testing.T) {
 	defer registry.Close()
 
 	repo := registry.AddRepo("library/osbuild")
-	repo.AddImage(
+	listDigest := repo.AddImage(
 		[]Blob{NewDataBlobFromBase64(rootLayer)},
 		[]string{"amd64", "ppc64le"},
 		"cool container",
@@ -40,11 +40,12 @@ func TestClientResolve(t *testing.T) {
 
 	assert.NoError(t, err)
 	assert.Equal(t, container.Spec{
-		Source:    ref,
-		Digest:    "sha256:f29b6cd42a94a574583439addcd6694e6224f0e4b32044c9e3aee4c4856c2a50",
-		ImageID:   "sha256:c2ecf25cf190e76b12b07436ad5140d4ba53d8a136d498705e57a006837a720f",
-		TLSVerify: client.GetTLSVerify(),
-		LocalName: ref,
+		Source:     ref,
+		Digest:     "sha256:f29b6cd42a94a574583439addcd6694e6224f0e4b32044c9e3aee4c4856c2a50",
+		ImageID:    "sha256:c2ecf25cf190e76b12b07436ad5140d4ba53d8a136d498705e57a006837a720f",
+		TLSVerify:  client.GetTLSVerify(),
+		LocalName:  ref,
+		ListDigest: listDigest,
 	}, spec)
 
 	client.SetArchitectureChoice("ppc64le")
@@ -52,11 +53,12 @@ func TestClientResolve(t *testing.T) {
 
 	assert.NoError(t, err)
 	assert.Equal(t, container.Spec{
-		Source:    ref,
-		Digest:    "sha256:d49eebefb6c7ce5505594bef652bd4adc36f413861bd44209d9b9486310b1264",
-		ImageID:   "sha256:d2ab8fea7f08a22f03b30c13c6ea443121f25e87202a7496e93736efa6fe345a",
-		TLSVerify: client.GetTLSVerify(),
-		LocalName: ref,
+		Source:     ref,
+		Digest:     "sha256:d49eebefb6c7ce5505594bef652bd4adc36f413861bd44209d9b9486310b1264",
+		ImageID:    "sha256:d2ab8fea7f08a22f03b30c13c6ea443121f25e87202a7496e93736efa6fe345a",
+		TLSVerify:  client.GetTLSVerify(),
+		LocalName:  ref,
+		ListDigest: listDigest,
 	}, spec)
 
 	// don't have that architecture
diff --git a/internal/container/container_test.go b/internal/container/container_test.go
index e1fe00ff5..85a945471 100644
--- a/internal/container/container_test.go
+++ b/internal/container/container_test.go
@@ -348,6 +348,7 @@ func (reg *Registry) Resolve(target, arch string) (container.Spec, error) {
 	}
 
 	lst, ok := repo.images[checksum]
+	listDigest := checksum
 
 	if ok {
 		checksum = ""
@@ -370,11 +371,12 @@ func (reg *Registry) Resolve(target, arch string) (container.Spec, error) {
 	}
 
 	return container.Spec{
-		Source:    ref.String(),
-		Digest:    checksum,
-		ImageID:   mf.ConfigDescriptor.Digest.String(),
-		LocalName: ref.String(),
-		TLSVerify: common.ToPtr(false),
+		Source:     ref.String(),
+		Digest:     checksum,
+		ImageID:    mf.ConfigDescriptor.Digest.String(),
+		LocalName:  ref.String(),
+		TLSVerify:  common.ToPtr(false),
+		ListDigest: listDigest,
 	}, nil
 }
 
-- 
2.40.0


From 1c09ad81d19de026537c4ad519cd50de76282882 Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Fri, 17 Mar 2023 18:26:09 +0100
Subject: [PATCH 15/22] test: add container source with manifest-list to
 manifests

Add a second container to the ostree-commit test manifests that refers
to a manifest list on the osbuild-composer registry on gitlab.
---
 ...rch64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...86_64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...rch64-edge_commit_with_container-boot.json | 36 +++++++++++++++++
 ...86_64-edge_commit_with_container-boot.json | 36 +++++++++++++++++
 ...arch64-iot_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...x86_64-iot_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...arch64-iot_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...x86_64-iot_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...arch64-iot_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...x86_64-iot_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...rch64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...86_64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...rch64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...86_64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...rch64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...86_64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...rch64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...86_64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...rch64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...86_64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...rch64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...86_64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...rch64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...86_64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...rch64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...86_64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...rch64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 .../rhel_91-aarch64-qcow2_customize-boot.json |  3 +-
 .../rhel_91-ppc64le-qcow2_customize-boot.json |  3 +-
 .../rhel_91-s390x-qcow2_customize-boot.json   |  3 +-
 ...86_64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 .../rhel_91-x86_64-qcow2_customize-boot.json  |  3 +-
 ...rch64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 ...86_64-edge_commit_with_container-boot.json | 39 ++++++++++++++++++-
 .../format-request-map.json                   |  6 +++
 35 files changed, 1150 insertions(+), 32 deletions(-)

diff --git a/test/data/manifests/centos_8-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/centos_8-aarch64-edge_commit_with_container-boot.json
index bd30a1485..ecf6766ab 100644
--- a/test/data/manifests/centos_8-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/centos_8-aarch64-edge_commit_with_container-boot.json
@@ -22,6 +22,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -4887,10 +4890,20 @@
                 "type": "org.osbuild.containers",
                 "origin": "org.osbuild.source",
                 "references": {
+                  "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                  },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -6164,6 +6177,12 @@
       },
       "org.osbuild.skopeo": {
         "items": {
+          "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb"
+            }
+          },
           "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
             "image": {
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
@@ -6171,6 +6190,15 @@
             }
           }
         }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
+          }
+        }
       }
     }
   },
@@ -12156,7 +12184,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
+      "TLSVerify": null,
+      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/centos_8-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/centos_8-x86_64-edge_commit_with_container-boot.json
index 056befaf7..097cc2005 100644
--- a/test/data/manifests/centos_8-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/centos_8-x86_64-edge_commit_with_container-boot.json
@@ -22,6 +22,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -5049,8 +5052,18 @@
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                  },
+                  "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -6374,6 +6387,21 @@
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
               "digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
             }
+          },
+          "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e"
+            }
+          }
+        }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
           }
         }
       }
@@ -12561,7 +12589,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
+      "TLSVerify": null,
+      "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/centos_9-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/centos_9-aarch64-edge_commit_with_container-boot.json
index db87c4eff..ec4673efe 100644
--- a/test/data/manifests/centos_9-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/centos_9-aarch64-edge_commit_with_container-boot.json
@@ -22,6 +22,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -4527,10 +4530,20 @@
                 "type": "org.osbuild.containers",
                 "origin": "org.osbuild.source",
                 "references": {
+                  "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                  },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -5785,6 +5798,12 @@
       },
       "org.osbuild.skopeo": {
         "items": {
+          "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb"
+            }
+          },
           "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
             "image": {
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
@@ -5792,6 +5811,15 @@
             }
           }
         }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
+          }
+        }
       }
     }
   },
@@ -11329,6 +11357,14 @@
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
       "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
       "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
+      "TLSVerify": null,
+      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/centos_9-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/centos_9-x86_64-edge_commit_with_container-boot.json
index acb5b01d7..d231b9496 100644
--- a/test/data/manifests/centos_9-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/centos_9-x86_64-edge_commit_with_container-boot.json
@@ -28,6 +28,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -4737,8 +4740,18 @@
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                  },
+                  "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -6040,6 +6053,21 @@
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
               "digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
             }
+          },
+          "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e"
+            }
+          }
+        }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
           }
         }
       }
@@ -11829,6 +11857,14 @@
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
       "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
       "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
+      "TLSVerify": null,
+      "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/fedora_36-aarch64-iot_commit_with_container-boot.json b/test/data/manifests/fedora_36-aarch64-iot_commit_with_container-boot.json
index 2dbe0953b..dca9bd472 100644
--- a/test/data/manifests/fedora_36-aarch64-iot_commit_with_container-boot.json
+++ b/test/data/manifests/fedora_36-aarch64-iot_commit_with_container-boot.json
@@ -36,6 +36,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -5393,10 +5396,20 @@
                 "type": "org.osbuild.containers",
                 "origin": "org.osbuild.source",
                 "references": {
+                  "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                  },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -6819,6 +6832,12 @@
       },
       "org.osbuild.skopeo": {
         "items": {
+          "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb"
+            }
+          },
           "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
             "image": {
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
@@ -6826,6 +6845,15 @@
             }
           }
         }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
+          }
+        }
       }
     }
   },
@@ -13421,7 +13449,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
+      "TLSVerify": null,
+      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/fedora_36-x86_64-iot_commit_with_container-boot.json b/test/data/manifests/fedora_36-x86_64-iot_commit_with_container-boot.json
index 7dde292e6..e3742a48a 100644
--- a/test/data/manifests/fedora_36-x86_64-iot_commit_with_container-boot.json
+++ b/test/data/manifests/fedora_36-x86_64-iot_commit_with_container-boot.json
@@ -36,6 +36,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -5515,8 +5518,18 @@
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                  },
+                  "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -6980,6 +6993,21 @@
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
               "digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
             }
+          },
+          "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e"
+            }
+          }
+        }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
           }
         }
       }
@@ -13727,7 +13755,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
+      "TLSVerify": null,
+      "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/fedora_37-aarch64-iot_commit_with_container-boot.json b/test/data/manifests/fedora_37-aarch64-iot_commit_with_container-boot.json
index 5d4c0c11a..9cce29ff4 100644
--- a/test/data/manifests/fedora_37-aarch64-iot_commit_with_container-boot.json
+++ b/test/data/manifests/fedora_37-aarch64-iot_commit_with_container-boot.json
@@ -22,6 +22,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -5463,10 +5466,20 @@
                 "type": "org.osbuild.containers",
                 "origin": "org.osbuild.source",
                 "references": {
+                  "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                  },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -6910,6 +6923,12 @@
       },
       "org.osbuild.skopeo": {
         "items": {
+          "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb"
+            }
+          },
           "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
             "image": {
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
@@ -6917,6 +6936,15 @@
             }
           }
         }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
+          }
+        }
       }
     }
   },
@@ -13622,7 +13650,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
+      "TLSVerify": null,
+      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/fedora_37-x86_64-iot_commit_with_container-boot.json b/test/data/manifests/fedora_37-x86_64-iot_commit_with_container-boot.json
index d14c1548d..5fc0b2ee4 100644
--- a/test/data/manifests/fedora_37-x86_64-iot_commit_with_container-boot.json
+++ b/test/data/manifests/fedora_37-x86_64-iot_commit_with_container-boot.json
@@ -22,6 +22,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -5585,8 +5588,18 @@
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                  },
+                  "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -7071,6 +7084,21 @@
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
               "digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
             }
+          },
+          "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e"
+            }
+          }
+        }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
           }
         }
       }
@@ -13928,7 +13956,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
+      "TLSVerify": null,
+      "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/fedora_38-aarch64-iot_commit_with_container-boot.json b/test/data/manifests/fedora_38-aarch64-iot_commit_with_container-boot.json
index 9c2a22488..3b2ddc32f 100644
--- a/test/data/manifests/fedora_38-aarch64-iot_commit_with_container-boot.json
+++ b/test/data/manifests/fedora_38-aarch64-iot_commit_with_container-boot.json
@@ -22,6 +22,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -5295,10 +5298,20 @@
                 "type": "org.osbuild.containers",
                 "origin": "org.osbuild.source",
                 "references": {
+                  "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                  },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -6745,6 +6758,12 @@
       },
       "org.osbuild.skopeo": {
         "items": {
+          "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb"
+            }
+          },
           "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
             "image": {
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
@@ -6752,6 +6771,15 @@
             }
           }
         }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
+          }
+        }
       }
     }
   },
@@ -13242,12 +13270,21 @@
     ]
   },
   "containers": [
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
+      "TLSVerify": null,
+      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+    },
     {
       "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/fedora_38-x86_64-iot_commit_with_container-boot.json b/test/data/manifests/fedora_38-x86_64-iot_commit_with_container-boot.json
index 7c48db788..f1986cd5f 100644
--- a/test/data/manifests/fedora_38-x86_64-iot_commit_with_container-boot.json
+++ b/test/data/manifests/fedora_38-x86_64-iot_commit_with_container-boot.json
@@ -22,6 +22,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -5401,8 +5404,18 @@
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                  },
+                  "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -6887,6 +6900,21 @@
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
               "digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
             }
+          },
+          "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e"
+            }
+          }
+        }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
           }
         }
       }
@@ -13514,7 +13542,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
+      "TLSVerify": null,
+      "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_8-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_8-aarch64-edge_commit_with_container-boot.json
index 84e24ad50..3218630de 100644
--- a/test/data/manifests/rhel_8-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_8-aarch64-edge_commit_with_container-boot.json
@@ -20,6 +20,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -1903,10 +1906,20 @@
                 "type": "org.osbuild.containers",
                 "origin": "org.osbuild.source",
                 "references": {
+                  "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                  },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -3191,6 +3204,12 @@
       },
       "org.osbuild.skopeo": {
         "items": {
+          "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb"
+            }
+          },
           "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
             "image": {
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
@@ -3198,6 +3217,15 @@
             }
           }
         }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
+          }
+        }
       }
     }
   },
@@ -8595,7 +8623,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
+      "TLSVerify": null,
+      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_8-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_8-x86_64-edge_commit_with_container-boot.json
index b39ce009c..24d984e15 100644
--- a/test/data/manifests/rhel_8-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_8-x86_64-edge_commit_with_container-boot.json
@@ -28,6 +28,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -1975,8 +1978,18 @@
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                  },
+                  "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -3311,6 +3324,21 @@
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
               "digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
             }
+          },
+          "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e"
+            }
+          }
+        }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
           }
         }
       }
@@ -8890,7 +8918,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
+      "TLSVerify": null,
+      "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_84-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_84-aarch64-edge_commit_with_container-boot.json
index 6a63178b6..8e24a89e7 100644
--- a/test/data/manifests/rhel_84-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_84-aarch64-edge_commit_with_container-boot.json
@@ -20,6 +20,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -1864,10 +1867,20 @@
                 "type": "org.osbuild.containers",
                 "origin": "org.osbuild.source",
                 "references": {
+                  "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                  },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -3159,6 +3172,12 @@
       },
       "org.osbuild.skopeo": {
         "items": {
+          "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb"
+            }
+          },
           "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
             "image": {
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
@@ -3166,6 +3185,15 @@
             }
           }
         }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
+          }
+        }
       }
     }
   },
@@ -8446,7 +8474,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
+      "TLSVerify": null,
+      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_84-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_84-x86_64-edge_commit_with_container-boot.json
index 99cb91709..2a7ca1509 100644
--- a/test/data/manifests/rhel_84-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_84-x86_64-edge_commit_with_container-boot.json
@@ -28,6 +28,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -1936,8 +1939,18 @@
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                  },
+                  "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -3279,6 +3292,21 @@
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
               "digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
             }
+          },
+          "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e"
+            }
+          }
+        }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
           }
         }
       }
@@ -8741,7 +8769,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
+      "TLSVerify": null,
+      "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_85-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_85-aarch64-edge_commit_with_container-boot.json
index 326fbdf79..76b1ee048 100644
--- a/test/data/manifests/rhel_85-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_85-aarch64-edge_commit_with_container-boot.json
@@ -20,6 +20,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -1885,10 +1888,20 @@
                 "type": "org.osbuild.containers",
                 "origin": "org.osbuild.source",
                 "references": {
+                  "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                  },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -3148,6 +3161,12 @@
       },
       "org.osbuild.skopeo": {
         "items": {
+          "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb"
+            }
+          },
           "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
             "image": {
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
@@ -3155,6 +3174,15 @@
             }
           }
         }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
+          }
+        }
       }
     }
   },
@@ -8498,7 +8526,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
+      "TLSVerify": null,
+      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_85-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_85-x86_64-edge_commit_with_container-boot.json
index 578e4bb55..bc67a9a85 100644
--- a/test/data/manifests/rhel_85-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_85-x86_64-edge_commit_with_container-boot.json
@@ -28,6 +28,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -1957,8 +1960,18 @@
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                  },
+                  "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -3268,6 +3281,21 @@
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
               "digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
             }
+          },
+          "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e"
+            }
+          }
+        }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
           }
         }
       }
@@ -8793,7 +8821,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
+      "TLSVerify": null,
+      "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_86-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_86-aarch64-edge_commit_with_container-boot.json
index 3dae2f682..0ce2c96a6 100644
--- a/test/data/manifests/rhel_86-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_86-aarch64-edge_commit_with_container-boot.json
@@ -20,6 +20,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -1897,10 +1900,20 @@
                 "type": "org.osbuild.containers",
                 "origin": "org.osbuild.source",
                 "references": {
+                  "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                  },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -3182,6 +3195,12 @@
       },
       "org.osbuild.skopeo": {
         "items": {
+          "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb"
+            }
+          },
           "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
             "image": {
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
@@ -3189,6 +3208,15 @@
             }
           }
         }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
+          }
+        }
       }
     }
   },
@@ -8568,7 +8596,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
+      "TLSVerify": null,
+      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_86-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_86-x86_64-edge_commit_with_container-boot.json
index 1713c7829..06b054f29 100644
--- a/test/data/manifests/rhel_86-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_86-x86_64-edge_commit_with_container-boot.json
@@ -28,6 +28,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -1969,8 +1972,18 @@
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                  },
+                  "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -3302,6 +3315,21 @@
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
               "digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
             }
+          },
+          "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e"
+            }
+          }
+        }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
           }
         }
       }
@@ -8863,7 +8891,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
+      "TLSVerify": null,
+      "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_87-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_87-aarch64-edge_commit_with_container-boot.json
index 22646a8a7..1a29f877e 100644
--- a/test/data/manifests/rhel_87-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_87-aarch64-edge_commit_with_container-boot.json
@@ -20,6 +20,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -1903,10 +1906,20 @@
                 "type": "org.osbuild.containers",
                 "origin": "org.osbuild.source",
                 "references": {
+                  "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                  },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -3191,6 +3204,12 @@
       },
       "org.osbuild.skopeo": {
         "items": {
+          "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb"
+            }
+          },
           "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
             "image": {
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
@@ -3198,6 +3217,15 @@
             }
           }
         }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
+          }
+        }
       }
     }
   },
@@ -8595,7 +8623,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
+      "TLSVerify": null,
+      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_87-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_87-x86_64-edge_commit_with_container-boot.json
index d2b334f67..24dada814 100644
--- a/test/data/manifests/rhel_87-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_87-x86_64-edge_commit_with_container-boot.json
@@ -28,6 +28,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -1975,8 +1978,18 @@
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                  },
+                  "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -3311,6 +3324,21 @@
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
               "digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
             }
+          },
+          "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e"
+            }
+          }
+        }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
           }
         }
       }
@@ -8890,7 +8918,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
+      "TLSVerify": null,
+      "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_88-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_88-aarch64-edge_commit_with_container-boot.json
index 9ca51e80b..baaf0b90d 100644
--- a/test/data/manifests/rhel_88-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_88-aarch64-edge_commit_with_container-boot.json
@@ -20,6 +20,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -1903,10 +1906,20 @@
                 "type": "org.osbuild.containers",
                 "origin": "org.osbuild.source",
                 "references": {
+                  "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                  },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -3191,6 +3204,12 @@
       },
       "org.osbuild.skopeo": {
         "items": {
+          "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb"
+            }
+          },
           "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
             "image": {
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
@@ -3198,6 +3217,15 @@
             }
           }
         }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
+          }
+        }
       }
     }
   },
@@ -8595,7 +8623,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
+      "TLSVerify": null,
+      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_88-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_88-x86_64-edge_commit_with_container-boot.json
index df26cad08..c75702c4a 100644
--- a/test/data/manifests/rhel_88-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_88-x86_64-edge_commit_with_container-boot.json
@@ -28,6 +28,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -1975,8 +1978,18 @@
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                  },
+                  "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -3311,6 +3324,21 @@
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
               "digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
             }
+          },
+          "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e"
+            }
+          }
+        }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
           }
         }
       }
@@ -8890,7 +8918,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
+      "TLSVerify": null,
+      "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_9-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_9-aarch64-edge_commit_with_container-boot.json
index 2ab515c4b..7ca727841 100644
--- a/test/data/manifests/rhel_9-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_9-aarch64-edge_commit_with_container-boot.json
@@ -22,6 +22,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -4575,10 +4578,20 @@
                 "type": "org.osbuild.containers",
                 "origin": "org.osbuild.source",
                 "references": {
+                  "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                  },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -5836,6 +5849,12 @@
       },
       "org.osbuild.skopeo": {
         "items": {
+          "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb"
+            }
+          },
           "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
             "image": {
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
@@ -5843,6 +5862,15 @@
             }
           }
         }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
+          }
+        }
       }
     }
   },
@@ -11438,7 +11466,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
+      "TLSVerify": null,
+      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_9-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_9-x86_64-edge_commit_with_container-boot.json
index 5eb599741..5ab941e81 100644
--- a/test/data/manifests/rhel_9-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_9-x86_64-edge_commit_with_container-boot.json
@@ -31,6 +31,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -4788,8 +4791,18 @@
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                  },
+                  "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -6094,6 +6107,21 @@
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
               "digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
             }
+          },
+          "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e"
+            }
+          }
+        }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
           }
         }
       }
@@ -11941,7 +11969,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
+      "TLSVerify": null,
+      "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_90-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_90-aarch64-edge_commit_with_container-boot.json
index 0daa7ef02..2cc34b97a 100644
--- a/test/data/manifests/rhel_90-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_90-aarch64-edge_commit_with_container-boot.json
@@ -20,6 +20,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -1777,10 +1780,20 @@
                 "type": "org.osbuild.containers",
                 "origin": "org.osbuild.source",
                 "references": {
+                  "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                  },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -3032,6 +3045,12 @@
       },
       "org.osbuild.skopeo": {
         "items": {
+          "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb"
+            }
+          },
           "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
             "image": {
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
@@ -3039,6 +3058,15 @@
             }
           }
         }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
+          }
+        }
       }
     }
   },
@@ -8058,7 +8086,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
+      "TLSVerify": null,
+      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_90-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_90-x86_64-edge_commit_with_container-boot.json
index 8d141c74a..98e39d67a 100644
--- a/test/data/manifests/rhel_90-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_90-x86_64-edge_commit_with_container-boot.json
@@ -28,6 +28,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -1867,8 +1870,18 @@
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                  },
+                  "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -3170,6 +3183,21 @@
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
               "digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
             }
+          },
+          "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e"
+            }
+          }
+        }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
           }
         }
       }
@@ -8425,7 +8453,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
+      "TLSVerify": null,
+      "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_91-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_91-aarch64-edge_commit_with_container-boot.json
index c53ca9fe3..96f0587bd 100644
--- a/test/data/manifests/rhel_91-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_91-aarch64-edge_commit_with_container-boot.json
@@ -22,6 +22,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -4575,10 +4578,20 @@
                 "type": "org.osbuild.containers",
                 "origin": "org.osbuild.source",
                 "references": {
+                  "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                  },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -5836,6 +5849,12 @@
       },
       "org.osbuild.skopeo": {
         "items": {
+          "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb"
+            }
+          },
           "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
             "image": {
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
@@ -5843,6 +5862,15 @@
             }
           }
         }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
+          }
+        }
       }
     }
   },
@@ -11438,7 +11466,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
+      "TLSVerify": null,
+      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_91-aarch64-qcow2_customize-boot.json b/test/data/manifests/rhel_91-aarch64-qcow2_customize-boot.json
index 499ec4487..878462742 100644
--- a/test/data/manifests/rhel_91-aarch64-qcow2_customize-boot.json
+++ b/test/data/manifests/rhel_91-aarch64-qcow2_customize-boot.json
@@ -13442,7 +13442,8 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_91-ppc64le-qcow2_customize-boot.json b/test/data/manifests/rhel_91-ppc64le-qcow2_customize-boot.json
index aa2870cab..32cc7bfc9 100644
--- a/test/data/manifests/rhel_91-ppc64le-qcow2_customize-boot.json
+++ b/test/data/manifests/rhel_91-ppc64le-qcow2_customize-boot.json
@@ -14937,7 +14937,8 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_91-s390x-qcow2_customize-boot.json b/test/data/manifests/rhel_91-s390x-qcow2_customize-boot.json
index 4fa7229f3..f12691619 100644
--- a/test/data/manifests/rhel_91-s390x-qcow2_customize-boot.json
+++ b/test/data/manifests/rhel_91-s390x-qcow2_customize-boot.json
@@ -15430,7 +15430,8 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_91-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_91-x86_64-edge_commit_with_container-boot.json
index 8e8c8d202..c9052dc32 100644
--- a/test/data/manifests/rhel_91-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_91-x86_64-edge_commit_with_container-boot.json
@@ -31,6 +31,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -4788,8 +4791,18 @@
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                  },
+                  "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -6094,6 +6107,21 @@
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
               "digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
             }
+          },
+          "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e"
+            }
+          }
+        }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
           }
         }
       }
@@ -11941,7 +11969,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
+      "TLSVerify": null,
+      "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_91-x86_64-qcow2_customize-boot.json b/test/data/manifests/rhel_91-x86_64-qcow2_customize-boot.json
index a6fa8cd0b..c94c84eb5 100644
--- a/test/data/manifests/rhel_91-x86_64-qcow2_customize-boot.json
+++ b/test/data/manifests/rhel_91-x86_64-qcow2_customize-boot.json
@@ -14273,7 +14273,8 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_92-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_92-aarch64-edge_commit_with_container-boot.json
index 65add64a4..f3ea895fa 100644
--- a/test/data/manifests/rhel_92-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_92-aarch64-edge_commit_with_container-boot.json
@@ -22,6 +22,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -4543,10 +4546,20 @@
                 "type": "org.osbuild.containers",
                 "origin": "org.osbuild.source",
                 "references": {
+                  "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                  },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -5812,6 +5825,12 @@
       },
       "org.osbuild.skopeo": {
         "items": {
+          "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb"
+            }
+          },
           "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
             "image": {
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
@@ -5819,6 +5838,15 @@
             }
           }
         }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
+          }
+        }
       }
     }
   },
@@ -11374,7 +11402,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
+      "TLSVerify": null,
+      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/rhel_92-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_92-x86_64-edge_commit_with_container-boot.json
index 223202d58..292208064 100644
--- a/test/data/manifests/rhel_92-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_92-x86_64-edge_commit_with_container-boot.json
@@ -31,6 +31,9 @@
       "containers": [
         {
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+        },
+        {
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
         }
       ]
     }
@@ -4756,8 +4759,18 @@
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
                     "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                  },
+                  "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
                   }
                 }
+              },
+              "manifest-lists": {
+                "type": "org.osbuild.files",
+                "origin": "org.osbuild.source",
+                "references": [
+                  "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+                ]
               }
             },
             "options": {
@@ -6070,6 +6083,21 @@
               "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
               "digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
             }
+          },
+          "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+              "digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e"
+            }
+          }
+        }
+      },
+      "org.osbuild.skopeo-index": {
+        "items": {
+          "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc": {
+            "image": {
+              "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            }
           }
         }
       }
@@ -11877,7 +11905,16 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
+      "TLSVerify": null,
+      "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/tools/test-case-generators/format-request-map.json b/tools/test-case-generators/format-request-map.json
index cb0a55552..f509c0275 100644
--- a/tools/test-case-generators/format-request-map.json
+++ b/tools/test-case-generators/format-request-map.json
@@ -123,6 +123,9 @@
         "containers": [
           {
             "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+          },
+          {
+            "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
           }
         ]
       }
@@ -296,6 +299,9 @@
         "containers": [
           {
             "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+          },
+          {
+            "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
           }
         ]
       }
-- 
2.40.0


From cd09d638c2cef740508e6e29b14ad233143b9c28 Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Mon, 27 Mar 2023 20:42:16 +0200
Subject: [PATCH 16/22] test/container-embedding: add container with
 manifest-list

Add a second container to the container-embedding test.  The digest
refers to a manifest-list to test the new feature.
---
 test/cases/container-embedding.sh | 28 +++++++++++++++++++++-------
 1 file changed, 21 insertions(+), 7 deletions(-)

diff --git a/test/cases/container-embedding.sh b/test/cases/container-embedding.sh
index 166eb9d0b..42d9a1259 100755
--- a/test/cases/container-embedding.sh
+++ b/test/cases/container-embedding.sh
@@ -54,16 +54,20 @@ BLUEPRINT_FILE=${TEMPDIR}/blueprint.toml
 COMPOSE_START=${TEMPDIR}/compose-start-${IMAGE_KEY}.json
 COMPOSE_INFO=${TEMPDIR}/compose-info-${IMAGE_KEY}.json
 
-IMAGE_DIGEST="sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
+FEDORA_IMAGE_DIGEST="sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
+MANIFEST_LIST_DIGEST="sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
 
 # Write a basic blueprint for our container.
 tee "$BLUEPRINT_FILE" > /dev/null << EOF
 name = "image"
-description = "A qcwo2 with an container"
+description = "A qcow2 with an container"
 version = "0.0.1"
 
 [[containers]]
-source = "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal@${IMAGE_DIGEST}"
+source = "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal@${FEDORA_IMAGE_DIGEST}"
+
+[[containers]]
+source = "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test@${MANIFEST_LIST_DIGEST}"
 EOF
 
 # Prepare the blueprint for the compose.
@@ -125,11 +129,21 @@ greenprint " Checking that image exists"
 INFO="$(sudo /usr/libexec/osbuild-composer-test/image-info "${IMAGE_FILENAME}")"
 
 IMAGE_ID="d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6"
-EXISTS=$(jq -e --arg id "${IMAGE_ID}" 'any(."container-images" | select(. != null and .[].Id == $id); .)' <<< "${INFO}")
+FEDORA_CONTAINER_EXISTS=$(jq -e --arg id "${IMAGE_ID}" 'any(."container-images" | select(. != null and .[].Id == $id); .)' <<< "${INFO}")
+
+if $FEDORA_CONTAINER_EXISTS; then
+  greenprint " fedora container image '${IMAGE_ID}' was found!"
+else
+  echo " fedora container image '${IMAGE_ID}' not in image."
+  exit 1
+fi
+
+# Check that the test image's manifest list was included
+MANIFEST_LIST_EXISTS=$(jq -e --arg id "${MANIFEST_LIST_DIGEST}" 'any(."container-images" | select(. != null and .[].Digest == $id); .)' <<< "${INFO}")
 
-if $EXISTS; then
-  greenprint " container image '${IMAGE_ID}' was found!"
+if $MANIFEST_LIST_EXISTS; then
+  greenprint " Manifest list digest '${MANIFEST_LIST_DIGEST}' was found!"
 else
-  echo " container image '${IMAGE_ID}' not in image."
+  echo " Manifest list digest '${MANIFEST_LIST_DIGEST}' not in image."
   exit 1
 fi
-- 
2.40.0


From 7e39c8cad9037b99aab1f14de2218e8b762fbf11 Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Mon, 27 Mar 2023 20:52:45 +0200
Subject: [PATCH 17/22] Schutzfile: osbuild commit

Pin osbuild to current main for manifest-list feature.
---
 Schutzfile | 26 +++++++++++++-------------
 1 file changed, 13 insertions(+), 13 deletions(-)

diff --git a/Schutzfile b/Schutzfile
index ef342ee72..f39897beb 100644
--- a/Schutzfile
+++ b/Schutzfile
@@ -2,7 +2,7 @@
   "fedora-36": {
     "dependencies": {
       "osbuild": {
-        "commit": "345b2a599788e0ce3090025c06a7480e7497a94d"
+        "commit": "76a80bd8c590dba4480305efcb067145db3bf347"
       }
     },
     "repos": [
@@ -79,7 +79,7 @@
   "fedora-37": {
     "dependencies": {
       "osbuild": {
-        "commit": "345b2a599788e0ce3090025c06a7480e7497a94d"
+        "commit": "76a80bd8c590dba4480305efcb067145db3bf347"
       }
     },
     "repos": [
@@ -156,28 +156,28 @@
   "rhel-8.4": {
     "dependencies": {
       "osbuild": {
-        "commit": "345b2a599788e0ce3090025c06a7480e7497a94d"
+        "commit": "76a80bd8c590dba4480305efcb067145db3bf347"
       }
     }
   },
   "rhel-8.6": {
     "dependencies": {
       "osbuild": {
-        "commit": "345b2a599788e0ce3090025c06a7480e7497a94d"
+        "commit": "76a80bd8c590dba4480305efcb067145db3bf347"
       }
     }
   },
   "rhel-8.7": {
     "dependencies": {
       "osbuild": {
-        "commit": "345b2a599788e0ce3090025c06a7480e7497a94d"
+        "commit": "76a80bd8c590dba4480305efcb067145db3bf347"
       }
     }
   },
   "rhel-8.8": {
     "dependencies": {
       "osbuild": {
-        "commit": "345b2a599788e0ce3090025c06a7480e7497a94d"
+        "commit": "76a80bd8c590dba4480305efcb067145db3bf347"
       }
     },
     "repos": [
@@ -223,21 +223,21 @@
   "rhel-9.0": {
     "dependencies": {
       "osbuild": {
-        "commit": "345b2a599788e0ce3090025c06a7480e7497a94d"
+        "commit": "76a80bd8c590dba4480305efcb067145db3bf347"
       }
     }
   },
   "rhel-9.1": {
     "dependencies": {
       "osbuild": {
-        "commit": "345b2a599788e0ce3090025c06a7480e7497a94d"
+        "commit": "76a80bd8c590dba4480305efcb067145db3bf347"
       }
     }
   },
   "rhel-9.2": {
     "dependencies": {
       "osbuild": {
-        "commit": "345b2a599788e0ce3090025c06a7480e7497a94d"
+        "commit": "76a80bd8c590dba4480305efcb067145db3bf347"
       }
     },
     "repos": [
@@ -283,21 +283,21 @@
   "centos-8": {
     "dependencies": {
       "osbuild": {
-        "commit": "345b2a599788e0ce3090025c06a7480e7497a94d"
+        "commit": "76a80bd8c590dba4480305efcb067145db3bf347"
       }
     }
   },
   "centos-9": {
     "dependencies": {
       "osbuild": {
-        "commit": "345b2a599788e0ce3090025c06a7480e7497a94d"
+        "commit": "76a80bd8c590dba4480305efcb067145db3bf347"
       }
     }
   },
   "centos-stream-9": {
     "dependencies": {
       "osbuild": {
-        "commit": "345b2a599788e0ce3090025c06a7480e7497a94d"
+        "commit": "76a80bd8c590dba4480305efcb067145db3bf347"
       }
     },
     "repos": [
@@ -343,7 +343,7 @@
   "centos-stream-8": {
     "dependencies": {
       "osbuild": {
-        "commit": "345b2a599788e0ce3090025c06a7480e7497a94d"
+        "commit": "76a80bd8c590dba4480305efcb067145db3bf347"
       }
     },
     "repos": [
-- 
2.40.0


From 49ef4577edf92e212d7a44d6186aaabb9d7b211d Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Sun, 2 Apr 2023 15:13:04 +0200
Subject: [PATCH 18/22] spec: depend on osbuild v83

Set the dependency to osbuild v83 which contains the new features for
preserving manifest lists for containers.

Added in https://github.com/osbuild/osbuild/pull/1252
---
 osbuild-composer.spec | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/osbuild-composer.spec b/osbuild-composer.spec
index 39c526dde..0a4512100 100644
--- a/osbuild-composer.spec
+++ b/osbuild-composer.spec
@@ -295,10 +295,10 @@ The core osbuild-composer binary. This is suitable both for spawning in containe
 Summary:    The worker for osbuild-composer
 Requires:   systemd
 Requires:   qemu-img
-Requires:   osbuild >= 81
-Requires:   osbuild-ostree >= 81
-Requires:   osbuild-lvm2 >= 81
-Requires:   osbuild-luks2 >= 81
+Requires:   osbuild >= 83
+Requires:   osbuild-ostree >= 83
+Requires:   osbuild-lvm2 >= 83
+Requires:   osbuild-luks2 >= 83
 Requires:   %{name}-dnf-json = %{version}-%{release}
 
 %description worker
-- 
2.40.0


From f14f4e4f98515fdb7d7273998d9e07463573512e Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Tue, 18 Apr 2023 15:32:28 +0200
Subject: [PATCH 19/22] container: explicitly set LocalName

Set the LocalName for the spec using a separate argument in the
NewSpec() constructor instead of reusing the `source` arg.
The name is already available in the calling scope in the client's
Resolve() method.

If the LocalName is an empty string, default to the remote (source)
reference.  This is a change from the previous behaviour which only used
the base source.Name().  The full source corresponds to the
user-provided source value, which includes any specified tag or digest.

The `name` argument which is used in the `Resolve()` function should
always correspond to the user-provided container name.
---
 internal/container/client.go |  2 +-
 internal/container/spec.go   | 10 ++++++----
 2 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/internal/container/client.go b/internal/container/client.go
index 5e03d31c1..e90fff79c 100644
--- a/internal/container/client.go
+++ b/internal/container/client.go
@@ -500,7 +500,7 @@ func (cl *Client) Resolve(ctx context.Context, name string) (Spec, error) {
 		return Spec{}, err
 	}
 
-	spec := NewSpec(cl.Target, ids.Manifest, ids.Config, cl.GetTLSVerify(), ids.ListManifest.String())
+	spec := NewSpec(cl.Target, ids.Manifest, ids.Config, cl.GetTLSVerify(), ids.ListManifest.String(), name)
 
 	return spec, nil
 }
diff --git a/internal/container/spec.go b/internal/container/spec.go
index a9db3f731..15fe1572a 100644
--- a/internal/container/spec.go
+++ b/internal/container/spec.go
@@ -22,14 +22,16 @@ type Spec struct {
 // NewSpec creates a new Spec from the essential information.
 // It also converts is the transition point from container
 // specific types (digest.Digest) to generic types (string).
-func NewSpec(source reference.Named, digest, imageID digest.Digest, tlsVerify *bool, listDigest string) Spec {
-	name := source.Name()
+func NewSpec(source reference.Named, digest, imageID digest.Digest, tlsVerify *bool, listDigest string, localName string) Spec {
+	if localName == "" {
+		localName = source.String()
+	}
 	return Spec{
-		Source:     name,
+		Source:     source.Name(),
 		Digest:     digest.String(),
 		TLSVerify:  tlsVerify,
 		ImageID:    imageID.String(),
-		LocalName:  name,
+		LocalName:  localName,
 		ListDigest: listDigest,
 	}
 }
-- 
2.40.0


From 0b199b1782f7dd722539efa431237e954b142f16 Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Wed, 19 Apr 2023 13:30:43 +0200
Subject: [PATCH 20/22] container: update unit tests to match expected
 behaviour

---
 internal/container/client_test.go    | 4 ++--
 internal/container/container_test.go | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/internal/container/client_test.go b/internal/container/client_test.go
index 49695dae9..eb7a44037 100644
--- a/internal/container/client_test.go
+++ b/internal/container/client_test.go
@@ -44,7 +44,7 @@ func TestClientResolve(t *testing.T) {
 		Digest:     "sha256:f29b6cd42a94a574583439addcd6694e6224f0e4b32044c9e3aee4c4856c2a50",
 		ImageID:    "sha256:c2ecf25cf190e76b12b07436ad5140d4ba53d8a136d498705e57a006837a720f",
 		TLSVerify:  client.GetTLSVerify(),
-		LocalName:  ref,
+		LocalName:  client.Target.String(),
 		ListDigest: listDigest,
 	}, spec)
 
@@ -57,7 +57,7 @@ func TestClientResolve(t *testing.T) {
 		Digest:     "sha256:d49eebefb6c7ce5505594bef652bd4adc36f413861bd44209d9b9486310b1264",
 		ImageID:    "sha256:d2ab8fea7f08a22f03b30c13c6ea443121f25e87202a7496e93736efa6fe345a",
 		TLSVerify:  client.GetTLSVerify(),
-		LocalName:  ref,
+		LocalName:  client.Target.String(),
 		ListDigest: listDigest,
 	}, spec)
 
diff --git a/internal/container/container_test.go b/internal/container/container_test.go
index 85a945471..52ce86504 100644
--- a/internal/container/container_test.go
+++ b/internal/container/container_test.go
@@ -374,7 +374,7 @@ func (reg *Registry) Resolve(target, arch string) (container.Spec, error) {
 		Source:     ref.String(),
 		Digest:     checksum,
 		ImageID:    mf.ConfigDescriptor.Digest.String(),
-		LocalName:  ref.String(),
+		LocalName:  target,
 		TLSVerify:  common.ToPtr(false),
 		ListDigest: listDigest,
 	}, nil
-- 
2.40.0


From 349d1ead968f8e787e61eb6bd8965bf2940e60f5 Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Wed, 19 Apr 2023 10:04:56 +0200
Subject: [PATCH 21/22] test: add "name" to test manifests with container

Add name field to the manifest-list-test container in the test
request.  The value is the same as the source but with a `v1` tag
added.

In the manifests, the name field for the manifest-list-test is added to
the skopeo stage.  The `name` option of the fedora-minimal container in
the skopeo stage is also changed to reflect the full source reference
including the `latest` tag.
---
 ...rch64-edge_commit_with_container-boot.json | 11 ++++----
 ...86_64-edge_commit_with_container-boot.json | 11 ++++----
 ...rch64-edge_commit_with_container-boot.json | 11 ++++----
 ...86_64-edge_commit_with_container-boot.json | 11 ++++----
 ...arch64-iot_commit_with_container-boot.json | 11 ++++----
 ...x86_64-iot_commit_with_container-boot.json | 11 ++++----
 ...arch64-iot_commit_with_container-boot.json | 11 ++++----
 ...x86_64-iot_commit_with_container-boot.json | 11 ++++----
 ...arch64-iot_commit_with_container-boot.json | 25 ++++++++++---------
 ...x86_64-iot_commit_with_container-boot.json | 11 ++++----
 ...rch64-edge_commit_with_container-boot.json | 11 ++++----
 ...86_64-edge_commit_with_container-boot.json | 11 ++++----
 ...rch64-edge_commit_with_container-boot.json | 11 ++++----
 ...86_64-edge_commit_with_container-boot.json | 11 ++++----
 ...rch64-edge_commit_with_container-boot.json | 11 ++++----
 ...86_64-edge_commit_with_container-boot.json | 11 ++++----
 ...rch64-edge_commit_with_container-boot.json | 11 ++++----
 ...86_64-edge_commit_with_container-boot.json | 11 ++++----
 ...rch64-edge_commit_with_container-boot.json | 11 ++++----
 ...86_64-edge_commit_with_container-boot.json | 11 ++++----
 ...rch64-edge_commit_with_container-boot.json | 11 ++++----
 ...86_64-edge_commit_with_container-boot.json | 11 ++++----
 ...rch64-edge_commit_with_container-boot.json | 11 ++++----
 ...86_64-edge_commit_with_container-boot.json | 11 ++++----
 ...rch64-edge_commit_with_container-boot.json | 11 ++++----
 ...86_64-edge_commit_with_container-boot.json | 11 ++++----
 ...rch64-edge_commit_with_container-boot.json | 11 ++++----
 .../rhel_91-aarch64-qcow2_customize-boot.json |  4 +--
 .../rhel_91-ppc64le-qcow2_customize-boot.json |  4 +--
 .../rhel_91-s390x-qcow2_customize-boot.json   |  4 +--
 ...86_64-edge_commit_with_container-boot.json | 11 ++++----
 .../rhel_91-x86_64-qcow2_customize-boot.json  |  4 +--
 ...rch64-edge_commit_with_container-boot.json | 11 ++++----
 ...86_64-edge_commit_with_container-boot.json | 11 ++++----
 .../format-request-map.json                   |  6 +++--
 35 files changed, 199 insertions(+), 167 deletions(-)

diff --git a/test/data/manifests/centos_8-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/centos_8-aarch64-edge_commit_with_container-boot.json
index ecf6766ab..0dc3b2a96 100644
--- a/test/data/manifests/centos_8-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/centos_8-aarch64-edge_commit_with_container-boot.json
@@ -24,7 +24,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -4891,10 +4892,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               },
@@ -12184,7 +12185,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -12192,7 +12193,7 @@
       "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
       "TLSVerify": null,
       "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/centos_8-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/centos_8-x86_64-edge_commit_with_container-boot.json
index 097cc2005..cf9f9ba1e 100644
--- a/test/data/manifests/centos_8-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/centos_8-x86_64-edge_commit_with_container-boot.json
@@ -24,7 +24,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -5051,10 +5052,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   },
                   "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   }
                 }
               },
@@ -12589,7 +12590,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -12597,7 +12598,7 @@
       "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
       "TLSVerify": null,
       "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/centos_9-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/centos_9-aarch64-edge_commit_with_container-boot.json
index ec4673efe..5498f7087 100644
--- a/test/data/manifests/centos_9-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/centos_9-aarch64-edge_commit_with_container-boot.json
@@ -24,7 +24,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -4531,10 +4532,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               },
@@ -11355,7 +11356,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -11363,7 +11364,7 @@
       "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
       "TLSVerify": null,
       "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/centos_9-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/centos_9-x86_64-edge_commit_with_container-boot.json
index d231b9496..4c70b8b2a 100644
--- a/test/data/manifests/centos_9-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/centos_9-x86_64-edge_commit_with_container-boot.json
@@ -30,7 +30,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -4739,10 +4740,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   },
                   "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   }
                 }
               },
@@ -11855,7 +11856,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -11863,7 +11864,7 @@
       "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
       "TLSVerify": null,
       "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/fedora_36-aarch64-iot_commit_with_container-boot.json b/test/data/manifests/fedora_36-aarch64-iot_commit_with_container-boot.json
index dca9bd472..0778bddb3 100644
--- a/test/data/manifests/fedora_36-aarch64-iot_commit_with_container-boot.json
+++ b/test/data/manifests/fedora_36-aarch64-iot_commit_with_container-boot.json
@@ -38,7 +38,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "manifest-list-test:v1"
         }
       ]
     }
@@ -5397,10 +5398,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "manifest-list-test:v1"
                   },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               },
@@ -13449,7 +13450,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -13457,7 +13458,7 @@
       "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
       "TLSVerify": null,
       "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/fedora_36-x86_64-iot_commit_with_container-boot.json b/test/data/manifests/fedora_36-x86_64-iot_commit_with_container-boot.json
index e3742a48a..ee971e308 100644
--- a/test/data/manifests/fedora_36-x86_64-iot_commit_with_container-boot.json
+++ b/test/data/manifests/fedora_36-x86_64-iot_commit_with_container-boot.json
@@ -38,7 +38,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "manifest-list-test:v1"
         }
       ]
     }
@@ -5517,10 +5518,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   },
                   "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "manifest-list-test:v1"
                   }
                 }
               },
@@ -13755,7 +13756,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -13763,7 +13764,7 @@
       "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
       "TLSVerify": null,
       "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/fedora_37-aarch64-iot_commit_with_container-boot.json b/test/data/manifests/fedora_37-aarch64-iot_commit_with_container-boot.json
index 9cce29ff4..07590c7ac 100644
--- a/test/data/manifests/fedora_37-aarch64-iot_commit_with_container-boot.json
+++ b/test/data/manifests/fedora_37-aarch64-iot_commit_with_container-boot.json
@@ -24,7 +24,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "manifest-list-test:v1"
         }
       ]
     }
@@ -5467,10 +5468,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "manifest-list-test:v1"
                   },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               },
@@ -13650,7 +13651,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -13658,7 +13659,7 @@
       "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
       "TLSVerify": null,
       "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/fedora_37-x86_64-iot_commit_with_container-boot.json b/test/data/manifests/fedora_37-x86_64-iot_commit_with_container-boot.json
index 5fc0b2ee4..37649e4ea 100644
--- a/test/data/manifests/fedora_37-x86_64-iot_commit_with_container-boot.json
+++ b/test/data/manifests/fedora_37-x86_64-iot_commit_with_container-boot.json
@@ -24,7 +24,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "manifest-list-test:v1"
         }
       ]
     }
@@ -5587,10 +5588,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   },
                   "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "manifest-list-test:v1"
                   }
                 }
               },
@@ -13956,7 +13957,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -13964,7 +13965,7 @@
       "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
       "TLSVerify": null,
       "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/fedora_38-aarch64-iot_commit_with_container-boot.json b/test/data/manifests/fedora_38-aarch64-iot_commit_with_container-boot.json
index 3b2ddc32f..c38f970d0 100644
--- a/test/data/manifests/fedora_38-aarch64-iot_commit_with_container-boot.json
+++ b/test/data/manifests/fedora_38-aarch64-iot_commit_with_container-boot.json
@@ -24,7 +24,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "manifest-list-test:v1"
         }
       ]
     }
@@ -5299,10 +5300,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "manifest-list-test:v1"
                   },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               },
@@ -13270,21 +13271,21 @@
     ]
   },
   "containers": [
-    {
-      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
-      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
-      "TLSVerify": null,
-      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
-      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
-    },
     {
       "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
+    },
+    {
+      "Source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
+      "TLSVerify": null,
+      "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
+      "LocalName": "manifest-list-test:v1",
+      "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
   "no-image-info": true
diff --git a/test/data/manifests/fedora_38-x86_64-iot_commit_with_container-boot.json b/test/data/manifests/fedora_38-x86_64-iot_commit_with_container-boot.json
index f1986cd5f..606a73907 100644
--- a/test/data/manifests/fedora_38-x86_64-iot_commit_with_container-boot.json
+++ b/test/data/manifests/fedora_38-x86_64-iot_commit_with_container-boot.json
@@ -24,7 +24,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "manifest-list-test:v1"
         }
       ]
     }
@@ -5403,10 +5404,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   },
                   "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "manifest-list-test:v1"
                   }
                 }
               },
@@ -13542,7 +13543,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -13550,7 +13551,7 @@
       "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
       "TLSVerify": null,
       "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_8-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_8-aarch64-edge_commit_with_container-boot.json
index 3218630de..c586347bd 100644
--- a/test/data/manifests/rhel_8-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_8-aarch64-edge_commit_with_container-boot.json
@@ -22,7 +22,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -1907,10 +1908,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               },
@@ -8623,7 +8624,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -8631,7 +8632,7 @@
       "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
       "TLSVerify": null,
       "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_8-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_8-x86_64-edge_commit_with_container-boot.json
index 24d984e15..474c7e0fd 100644
--- a/test/data/manifests/rhel_8-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_8-x86_64-edge_commit_with_container-boot.json
@@ -30,7 +30,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -1977,10 +1978,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   },
                   "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   }
                 }
               },
@@ -8918,7 +8919,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -8926,7 +8927,7 @@
       "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
       "TLSVerify": null,
       "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_84-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_84-aarch64-edge_commit_with_container-boot.json
index 8e24a89e7..48cc58419 100644
--- a/test/data/manifests/rhel_84-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_84-aarch64-edge_commit_with_container-boot.json
@@ -22,7 +22,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -1868,10 +1869,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               },
@@ -8474,7 +8475,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -8482,7 +8483,7 @@
       "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
       "TLSVerify": null,
       "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_84-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_84-x86_64-edge_commit_with_container-boot.json
index 2a7ca1509..f911e978c 100644
--- a/test/data/manifests/rhel_84-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_84-x86_64-edge_commit_with_container-boot.json
@@ -30,7 +30,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -1938,10 +1939,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   },
                   "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   }
                 }
               },
@@ -8769,7 +8770,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -8777,7 +8778,7 @@
       "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
       "TLSVerify": null,
       "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_85-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_85-aarch64-edge_commit_with_container-boot.json
index 76b1ee048..2dbd7bc0f 100644
--- a/test/data/manifests/rhel_85-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_85-aarch64-edge_commit_with_container-boot.json
@@ -22,7 +22,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -1889,10 +1890,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               },
@@ -8526,7 +8527,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -8534,7 +8535,7 @@
       "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
       "TLSVerify": null,
       "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_85-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_85-x86_64-edge_commit_with_container-boot.json
index bc67a9a85..0ae6d880f 100644
--- a/test/data/manifests/rhel_85-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_85-x86_64-edge_commit_with_container-boot.json
@@ -30,7 +30,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -1959,10 +1960,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   },
                   "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   }
                 }
               },
@@ -8821,7 +8822,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -8829,7 +8830,7 @@
       "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
       "TLSVerify": null,
       "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_86-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_86-aarch64-edge_commit_with_container-boot.json
index 0ce2c96a6..c6add0335 100644
--- a/test/data/manifests/rhel_86-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_86-aarch64-edge_commit_with_container-boot.json
@@ -22,7 +22,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -1901,10 +1902,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               },
@@ -8596,7 +8597,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -8604,7 +8605,7 @@
       "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
       "TLSVerify": null,
       "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_86-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_86-x86_64-edge_commit_with_container-boot.json
index 06b054f29..e4d716a71 100644
--- a/test/data/manifests/rhel_86-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_86-x86_64-edge_commit_with_container-boot.json
@@ -30,7 +30,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -1971,10 +1972,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   },
                   "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   }
                 }
               },
@@ -8891,7 +8892,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -8899,7 +8900,7 @@
       "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
       "TLSVerify": null,
       "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_87-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_87-aarch64-edge_commit_with_container-boot.json
index 1a29f877e..1af6201e1 100644
--- a/test/data/manifests/rhel_87-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_87-aarch64-edge_commit_with_container-boot.json
@@ -22,7 +22,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -1907,10 +1908,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               },
@@ -8623,7 +8624,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -8631,7 +8632,7 @@
       "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
       "TLSVerify": null,
       "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_87-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_87-x86_64-edge_commit_with_container-boot.json
index 24dada814..d31893e37 100644
--- a/test/data/manifests/rhel_87-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_87-x86_64-edge_commit_with_container-boot.json
@@ -30,7 +30,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -1977,10 +1978,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   },
                   "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   }
                 }
               },
@@ -8918,7 +8919,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -8926,7 +8927,7 @@
       "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
       "TLSVerify": null,
       "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_88-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_88-aarch64-edge_commit_with_container-boot.json
index baaf0b90d..1e144282c 100644
--- a/test/data/manifests/rhel_88-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_88-aarch64-edge_commit_with_container-boot.json
@@ -22,7 +22,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -1907,10 +1908,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               },
@@ -8623,7 +8624,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -8631,7 +8632,7 @@
       "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
       "TLSVerify": null,
       "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_88-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_88-x86_64-edge_commit_with_container-boot.json
index c75702c4a..9a86f87d6 100644
--- a/test/data/manifests/rhel_88-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_88-x86_64-edge_commit_with_container-boot.json
@@ -30,7 +30,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -1977,10 +1978,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   },
                   "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   }
                 }
               },
@@ -8918,7 +8919,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -8926,7 +8927,7 @@
       "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
       "TLSVerify": null,
       "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_9-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_9-aarch64-edge_commit_with_container-boot.json
index 7ca727841..feea13062 100644
--- a/test/data/manifests/rhel_9-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_9-aarch64-edge_commit_with_container-boot.json
@@ -24,7 +24,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -4579,10 +4580,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               },
@@ -11466,7 +11467,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -11474,7 +11475,7 @@
       "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
       "TLSVerify": null,
       "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_9-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_9-x86_64-edge_commit_with_container-boot.json
index 5ab941e81..405f66cef 100644
--- a/test/data/manifests/rhel_9-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_9-x86_64-edge_commit_with_container-boot.json
@@ -33,7 +33,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -4790,10 +4791,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   },
                   "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   }
                 }
               },
@@ -11969,7 +11970,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -11977,7 +11978,7 @@
       "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
       "TLSVerify": null,
       "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_90-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_90-aarch64-edge_commit_with_container-boot.json
index 2cc34b97a..797861030 100644
--- a/test/data/manifests/rhel_90-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_90-aarch64-edge_commit_with_container-boot.json
@@ -22,7 +22,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -1781,10 +1782,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               },
@@ -8086,7 +8087,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -8094,7 +8095,7 @@
       "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
       "TLSVerify": null,
       "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_90-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_90-x86_64-edge_commit_with_container-boot.json
index 98e39d67a..5bad89cd1 100644
--- a/test/data/manifests/rhel_90-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_90-x86_64-edge_commit_with_container-boot.json
@@ -30,7 +30,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -1869,10 +1870,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   },
                   "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   }
                 }
               },
@@ -8453,7 +8454,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -8461,7 +8462,7 @@
       "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
       "TLSVerify": null,
       "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_91-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_91-aarch64-edge_commit_with_container-boot.json
index 96f0587bd..f2d899ce9 100644
--- a/test/data/manifests/rhel_91-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_91-aarch64-edge_commit_with_container-boot.json
@@ -24,7 +24,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -4579,10 +4580,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               },
@@ -11466,7 +11467,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -11474,7 +11475,7 @@
       "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
       "TLSVerify": null,
       "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_91-aarch64-qcow2_customize-boot.json b/test/data/manifests/rhel_91-aarch64-qcow2_customize-boot.json
index 878462742..d37d1f55c 100644
--- a/test/data/manifests/rhel_91-aarch64-qcow2_customize-boot.json
+++ b/test/data/manifests/rhel_91-aarch64-qcow2_customize-boot.json
@@ -5186,7 +5186,7 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               }
@@ -13442,7 +13442,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     }
   ],
diff --git a/test/data/manifests/rhel_91-ppc64le-qcow2_customize-boot.json b/test/data/manifests/rhel_91-ppc64le-qcow2_customize-boot.json
index 32cc7bfc9..896966d2b 100644
--- a/test/data/manifests/rhel_91-ppc64le-qcow2_customize-boot.json
+++ b/test/data/manifests/rhel_91-ppc64le-qcow2_customize-boot.json
@@ -5794,7 +5794,7 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               }
@@ -14937,7 +14937,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     }
   ],
diff --git a/test/data/manifests/rhel_91-s390x-qcow2_customize-boot.json b/test/data/manifests/rhel_91-s390x-qcow2_customize-boot.json
index f12691619..115aaae0c 100644
--- a/test/data/manifests/rhel_91-s390x-qcow2_customize-boot.json
+++ b/test/data/manifests/rhel_91-s390x-qcow2_customize-boot.json
@@ -6018,7 +6018,7 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               }
@@ -15430,7 +15430,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     }
   ],
diff --git a/test/data/manifests/rhel_91-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_91-x86_64-edge_commit_with_container-boot.json
index c9052dc32..00dc71480 100644
--- a/test/data/manifests/rhel_91-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_91-x86_64-edge_commit_with_container-boot.json
@@ -33,7 +33,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -4790,10 +4791,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   },
                   "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   }
                 }
               },
@@ -11969,7 +11970,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -11977,7 +11978,7 @@
       "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
       "TLSVerify": null,
       "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_91-x86_64-qcow2_customize-boot.json b/test/data/manifests/rhel_91-x86_64-qcow2_customize-boot.json
index c94c84eb5..c1bb51e32 100644
--- a/test/data/manifests/rhel_91-x86_64-qcow2_customize-boot.json
+++ b/test/data/manifests/rhel_91-x86_64-qcow2_customize-boot.json
@@ -5522,7 +5522,7 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               }
@@ -14273,7 +14273,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     }
   ],
diff --git a/test/data/manifests/rhel_92-aarch64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_92-aarch64-edge_commit_with_container-boot.json
index f3ea895fa..3071e7a58 100644
--- a/test/data/manifests/rhel_92-aarch64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_92-aarch64-edge_commit_with_container-boot.json
@@ -24,7 +24,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -4547,10 +4548,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   },
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   }
                 }
               },
@@ -11402,7 +11403,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -11410,7 +11411,7 @@
       "Digest": "sha256:1a19a94647b1379fed8c23eb7553327cb604ba546eb93f9f6c1e6d11911c8beb",
       "TLSVerify": null,
       "ImageID": "sha256:62d2a7b3bf9e0b4f3aba22553d6971227b5a39f7f408d46347b1ee74eb97cb20",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/test/data/manifests/rhel_92-x86_64-edge_commit_with_container-boot.json b/test/data/manifests/rhel_92-x86_64-edge_commit_with_container-boot.json
index 292208064..1a3709853 100644
--- a/test/data/manifests/rhel_92-x86_64-edge_commit_with_container-boot.json
+++ b/test/data/manifests/rhel_92-x86_64-edge_commit_with_container-boot.json
@@ -33,7 +33,8 @@
           "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
         },
         {
-          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+          "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+          "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
         }
       ]
     }
@@ -4758,10 +4759,10 @@
                 "origin": "org.osbuild.source",
                 "references": {
                   "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest"
                   },
                   "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99": {
-                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+                    "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
                   }
                 }
               },
@@ -11905,7 +11906,7 @@
       "Digest": "sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b",
       "TLSVerify": null,
       "ImageID": "sha256:d4ee87dab8193afad523b1042b9d3f5ec887555a704e5aaec2876798ebb585a6",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal:latest",
       "ListDigest": ""
     },
     {
@@ -11913,7 +11914,7 @@
       "Digest": "sha256:601c98c8148720ec5c29b8e854a1d5d88faddbc443eca12920d76cf993d7290e",
       "TLSVerify": null,
       "ImageID": "sha256:dbb63178dc9157068107961f11397df3fb62c02fa64f697d571bf84aad71cb99",
-      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+      "LocalName": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1",
       "ListDigest": "sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
     }
   ],
diff --git a/tools/test-case-generators/format-request-map.json b/tools/test-case-generators/format-request-map.json
index f509c0275..96bb5b209 100644
--- a/tools/test-case-generators/format-request-map.json
+++ b/tools/test-case-generators/format-request-map.json
@@ -125,7 +125,8 @@
             "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
           },
           {
-            "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+            "name": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test:v1"
           }
         ]
       }
@@ -301,7 +302,8 @@
             "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal"
           },
           {
-            "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test"
+            "source": "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test",
+            "name": "manifest-list-test:v1"
           }
         ]
       }
-- 
2.40.0


From c3af4a847284f2c87fa7fd6f017fba7988034cf8 Mon Sep 17 00:00:00 2001
From: Achilleas Koutsou <achilleas@koutsou.net>
Date: Wed, 19 Apr 2023 12:44:08 +0200
Subject: [PATCH 22/22] test/container-embedding: add checks for container
 names

Add a local name for the fedora minimal image which includes the tag
`v1`.

Check the image info for the expected names:
1. For the fedora-minimal image, the name as it appears in the blueprint
   should be included in the names list.
2. For the manifest-list-test image, the full source reference should be
   included in the names list since no name was specified in the
   blueprint.
---
 test/cases/container-embedding.sh | 25 ++++++++++++++++++++++++-
 1 file changed, 24 insertions(+), 1 deletion(-)

diff --git a/test/cases/container-embedding.sh b/test/cases/container-embedding.sh
index 42d9a1259..ba17901e6 100755
--- a/test/cases/container-embedding.sh
+++ b/test/cases/container-embedding.sh
@@ -55,7 +55,9 @@ COMPOSE_START=${TEMPDIR}/compose-start-${IMAGE_KEY}.json
 COMPOSE_INFO=${TEMPDIR}/compose-info-${IMAGE_KEY}.json
 
 FEDORA_IMAGE_DIGEST="sha256:4d76a7480ce1861c95975945633dc9d03807ffb45c64b664ef22e673798d414b"
+FEDORA_LOCAL_NAME="localhost/fedora-minimal:v1"
 MANIFEST_LIST_DIGEST="sha256:58150862447d05feeb263ddb7257bf11d2ce2a697362ac117de2184d10f028fc"
+MANIFEST_LIST_SOURCE="registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test@${MANIFEST_LIST_DIGEST}"
 
 # Write a basic blueprint for our container.
 tee "$BLUEPRINT_FILE" > /dev/null << EOF
@@ -65,9 +67,10 @@ version = "0.0.1"
 
 [[containers]]
 source = "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/fedora-minimal@${FEDORA_IMAGE_DIGEST}"
+name = "${FEDORA_LOCAL_NAME}"
 
 [[containers]]
-source = "registry.gitlab.com/redhat/services/products/image-builder/ci/osbuild-composer/manifest-list-test@${MANIFEST_LIST_DIGEST}"
+source = "${MANIFEST_LIST_SOURCE}"
 EOF
 
 # Prepare the blueprint for the compose.
@@ -138,6 +141,16 @@ else
   exit 1
 fi
 
+# Check that the local name was set in the names array
+FEDORA_NAME_EXISTS=$(jq -e --arg name "${FEDORA_LOCAL_NAME}" 'any(."container-images"[].Names[] | select(. != null and . == $name); .)' <<< "${INFO}")
+
+if $FEDORA_NAME_EXISTS; then
+  greenprint " fedora container image's name ${FEDORA_LOCAL_NAME}' was found!"
+else
+  echo " fedora container image's name '${FEDORA_LOCAL_NAME}' not in image."
+  exit 1
+fi
+
 # Check that the test image's manifest list was included
 MANIFEST_LIST_EXISTS=$(jq -e --arg id "${MANIFEST_LIST_DIGEST}" 'any(."container-images" | select(. != null and .[].Digest == $id); .)' <<< "${INFO}")
 
@@ -147,3 +160,13 @@ else
   echo " Manifest list digest '${MANIFEST_LIST_DIGEST}' not in image."
   exit 1
 fi
+
+# Check that the source was set in the names array as a fallback for the name
+MANIFEST_NAME_EXISTS=$(jq -e --arg name "${MANIFEST_LIST_SOURCE}" 'any(."container-images"[].Names[] | select(. != null and . == $name); .)' <<< "${INFO}")
+
+if $MANIFEST_NAME_EXISTS; then
+  greenprint " Manifest list's name '${MANIFEST_LIST_SOURCE}' was found!"
+else
+  echo " Manifest list digest's name '${MANIFEST_LIST_SOURCE}' not in image."
+  exit 1
+fi
-- 
2.40.0

